// Fallo - Project Management Application
// Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============== ENUMS ==============

enum UserPermission {
  VIEWER
  MEMBER
  ADMIN
  SUPER_ADMIN

  @@map("UserRole")
}

enum CardType {
  TASK
  USER_STORY
  EPIC
  UTILITY
}

enum UtilitySubtype {
  LINK
  NOTE
  MILESTONE
  BLOCKER
}

enum UserStoryFlag {
  COMPLEX
  HIGH_RISK
  MISSING_DOCS
  BLOCKED
  NEEDS_REVIEW
}

enum ListViewType {
  TASKS // Lists for Tasks view (artist view)
  PLANNING // Lists for Planning view (Epics & User Stories)
}

enum ListPhase {
  BACKLOG
  SPINE_PROTOTYPE
  CONCEPT
  PRODUCTION
  TWEAK
  DONE
}

enum EvaluatorRole {
  LEAD
  PO
  HEAD_OF_ART
}

enum ReviewScoreValue {
  LOW
  MEDIUM
  HIGH
  NOT_APPLICABLE
}

// ============== MODELS ==============

// Organization hierarchy
model Studio {
  id          String    @id @default(cuid())
  name        String
  description String?
  image       String? // Header image URL
  color       String? // Brand color
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  archivedAt  DateTime?

  teams        Team[]
  skills       Skill[]
  tags         Tag[]
  blockTypes   BlockType[]
  eventTypes   EventType[]
  companyRoles CompanyRole[]

  @@map("studios")
}

model Team {
  id          String    @id @default(cuid())
  name        String
  description String?
  image       String? // Header image URL
  color       String // Team color (required for timeline)
  position    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  archivedAt  DateTime?
  settings    Json?     @default("{}") // TeamSettings JSON (Slack, role assignments, etc.)

  studioId String? // Optional - some teams may not belong to a studio
  studio   Studio?      @relation(fields: [studioId], references: [id])
  members  TeamMember[]
  boards   Board[]

  @@index([studioId])
  @@map("teams")
}

model TeamMember {
  id         String         @id @default(cuid())
  permission UserPermission @default(MEMBER) @map("role")
  title      String? // Job title: Lead, Artist, Animator, etc.
  joinedAt   DateTime       @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_members")
}

// Skills system
model Skill {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  studioId   String? // null = global skill
  studio     Studio?     @relation(fields: [studioId], references: [id])
  userSkills UserSkill[]

  @@index([studioId])
  @@map("skills")
}

model UserSkill {
  id         String   @id @default(cuid())
  assignedAt DateTime @default(now())

  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillId String
  skill   Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@map("user_skills")
}

// Company roles (job functions: PO, Lead, Artist, etc.)
model CompanyRole {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?
  position    Int      @default(0)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  studioId         String?
  studio           Studio?           @relation(fields: [studioId], references: [id])
  userCompanyRoles UserCompanyRole[]

  @@index([studioId])
  @@map("company_roles")
}

model UserCompanyRole {
  id         String   @id @default(cuid())
  assignedAt DateTime @default(now())

  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyRoleId String
  companyRole   CompanyRole @relation(fields: [companyRoleId], references: [id], onDelete: Cascade)

  @@unique([userId, companyRoleId])
  @@map("user_company_roles")
}

// Tags for tasks
model Tag {
  id          String   @id @default(cuid())
  name        String
  color       String?
  description String?
  position    Int      @default(0)
  createdAt   DateTime @default(now())

  studioId String? // null = global tag
  studio   Studio?   @relation(fields: [studioId], references: [id])
  cardTags CardTag[]

  @@unique([studioId, name])
  @@index([studioId])
  @@map("tags")
}

model EpicNamePreset {
  id          String   @id @default(cuid())
  name        String
  description String?
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name])
  @@index([position])
  @@map("epic_name_presets")
}

model BoardModule {
  id                    String   @id @default(cuid())
  name                  String
  description           String?
  symbol                String
  epicName              String
  userStoryDescription  String?
  userStoryFeatureImage String?
  taskTemplates         Json     @default("[]")
  position              Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([symbol])
  @@index([position])
  @@map("board_modules")
}

model ModuleImageAsset {
  id        String   @id @default(cuid())
  name      String
  url       String   @unique
  tags      Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
  @@map("module_image_assets")
}

model GameSheetDocument {
  id         String    @id @default(cuid())
  name       String
  data       Json      @default("{}")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime?

  @@index([updatedAt])
  @@map("game_sheet_documents")
}

model CardTag {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  cardId String
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  tagId  String
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([cardId, tagId])
  @@map("card_tags")
}

// Block types for timeline
model BlockType {
  id          String   @id @default(cuid())
  name        String // SPINE_PROTOTYPE, CONCEPT, PRODUCTION, TWEAK, etc.
  color       String
  description String?
  isDefault   Boolean  @default(false) // Pre-seeded types
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  studioId           String?
  studio             Studio?                    @relation(fields: [studioId], references: [id])
  blocks             TimelineBlock[]
  coreTemplateBlocks CoreProjectTemplateBlock[]

  @@index([studioId])
  @@map("block_types")
}

// Event types for timeline
model EventType {
  id          String   @id @default(cuid())
  name        String // GSD, Marketing Deadline, Review, etc.
  color       String
  icon        String? // Optional icon identifier
  description String?
  isDefault   Boolean  @default(false)
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  studioId           String?
  studio             Studio?                    @relation(fields: [studioId], references: [id])
  events             TimelineEvent[]
  coreTemplateEvents CoreProjectTemplateEvent[]

  @@index([studioId])
  @@map("event_types")
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  name             String?
  image            String?
  slackUserId      String?        @unique
  slackDisplayName String?
  slackAvatarUrl   String?
  passwordHash     String? // For credentials auth
  permission       UserPermission @default(MEMBER) @map("role")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime? // Soft delete - user data preserved on boards

  // Relations
  boardMembers  BoardMember[]
  assignedCards CardUser[]
  comments      Comment[]
  activities    Activity[]
  attachments   Attachment[]
  evaluations   Evaluation[]

  // Organization relations
  teamMembers        TeamMember[]
  userSkills         UserSkill[]
  userCompanyRoles   UserCompanyRole[]
  timeLogs           TimeLog[]
  weeklyAvailability UserWeeklyAvailability[]

  // Notifications
  notifications Notification[]

  // NextAuth relations
  accounts Account[]
  sessions Session[]
  spineSettings UserSpineSettings?

  @@map("users")
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth Verification Token model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Represents both boards (Trello-like workspace with lists/cards) and projects
/// (high-level view with dates, roles, stats). A "project" is a non-template board
/// (isTemplate = false). Both /boards/[id] and /projects/[id] pages read the same row.
model Board {
  id          String    @id @default(cuid())
  name        String
  description String?
  isTemplate  Boolean   @default(false)
  settings    Json      @default("{}") // LLM settings, project dates, links, etc.
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  archivedAt  DateTime?

  // Relations
  members        BoardMember[]
  lists          List[]
  activities     Activity[]
  weeklyProgress WeeklyProgress[]

  // Team relation
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  // Timeline relations
  timelineBlocks     TimelineBlock[]
  timelineEvents     TimelineEvent[]
  weeklyAvailability UserWeeklyAvailability[]

  // Spine Tracker
  spineTrackerData SpineTrackerData?

  @@index([teamId])
  @@map("boards")
}

// Core project templates (date-agnostic sequence of timeline blocks/events)
model CoreProjectTemplate {
  id          String    @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean   @default(false)
  position    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  archivedAt  DateTime?

  blocks CoreProjectTemplateBlock[]
  events CoreProjectTemplateEvent[]

  @@index([position])
  @@map("core_project_templates")
}

model CoreProjectTemplateBlock {
  id        String   @id @default(cuid())
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templateId  String
  template    CoreProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  blockTypeId String
  blockType   BlockType           @relation(fields: [blockTypeId], references: [id])

  @@index([templateId, position])
  @@map("core_project_template_blocks")
}

model CoreProjectTemplateEvent {
  id         String   @id @default(cuid())
  position   Int
  unitOffset Int      @default(0) // 0-based business-day unit from template start
  title      String? // Optional override; falls back to event type name
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  templateId  String
  template    CoreProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  eventTypeId String
  eventType   EventType           @relation(fields: [eventTypeId], references: [id])

  @@index([templateId, position])
  @@map("core_project_template_events")
}

model BoardMember {
  id         String         @id @default(cuid())
  permission UserPermission @default(MEMBER) @map("role")
  joinedAt   DateTime       @default(now())

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([userId, boardId])
  @@map("board_members")
}

model List {
  id        String   @id @default(cuid())
  name      String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // View-specific fields
  viewType      ListViewType @default(TASKS) // Which view this list belongs to
  phase         ListPhase? // For planning lists: phase type
  color         String? // Hex color for list header
  startDate     DateTime? // Start date for planning lists
  endDate       DateTime? // End date for planning lists
  durationWeeks Int? // Default duration in weeks
  durationDays  Int? // Duration in business days (for 5-day blocks)

  // Relations
  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards   Card[]

  // Timeline sync
  timelineBlock TimelineBlock?
  timeLogs      TimeLog[]

  @@index([boardId])
  @@index([viewType])
  @@map("lists")
}

model Card {
  id                   String    @id @default(cuid())
  type                 CardType
  title                String
  description          String?
  position             Int
  color                String? // Hex color
  featureImage         String? // URL
  featureImagePosition Int       @default(50) // 0-100 vertical position %
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  archivedAt           DateTime?

  // Relations
  listId       String
  list         List          @relation(fields: [listId], references: [id], onDelete: Cascade)
  assignees    CardUser[]
  comments     Comment[]
  attachments  Attachment[]
  checklists   Checklist[]
  reviewCycles ReviewCycle[]

  // Hierarchy relations
  parentId String?
  parent   Card?   @relation("CardHierarchy", fields: [parentId], references: [id])
  children Card[]  @relation("CardHierarchy")

  // Type-specific data (JSON for flexibility)
  taskData      Json? // TaskCardData
  userStoryData Json? // UserStoryCardData
  epicData      Json? // EpicCardData
  utilityData   Json? // UtilityCardData

  // Tags and time tracking
  tags     CardTag[]
  timeLogs TimeLog[]

  @@index([listId])
  @@index([parentId])
  @@index([type])
  @@map("cards")
}

model ReviewCycle {
  id          String    @id @default(cuid())
  cycleNumber Int
  openedAt    DateTime  @default(now())
  closedAt    DateTime?
  isFinal     Boolean   @default(false)
  lockedAt    DateTime?

  cardId String
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  evaluations Evaluation[]

  @@unique([cardId, cycleNumber])
  @@index([cardId])
  @@map("review_cycles")
}

model ReviewDimension {
  id          String   @id @default(cuid())
  name        String
  description String?
  position    Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  evaluationScores EvaluationScore[]
  dimensionRoles   DimensionRole[]

  @@index([position])
  @@map("review_dimensions")
}

model DimensionRole {
  id          String          @id @default(cuid())
  dimensionId String
  dimension   ReviewDimension @relation(fields: [dimensionId], references: [id], onDelete: Cascade)
  role        EvaluatorRole

  @@unique([dimensionId, role])
  @@map("dimension_roles")
}

model Evaluation {
  id          String   @id @default(cuid())
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reviewCycleId String
  reviewCycle   ReviewCycle @relation(fields: [reviewCycleId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation(fields: [reviewerId], references: [id])

  scores EvaluationScore[]

  @@unique([reviewCycleId, reviewerId])
  @@index([reviewCycleId])
  @@index([reviewerId])
  @@map("evaluations")
}

model EvaluationScore {
  id    String           @id @default(cuid())
  score ReviewScoreValue

  evaluationId String
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  dimensionId String
  dimension   ReviewDimension @relation(fields: [dimensionId], references: [id])

  @@unique([evaluationId, dimensionId])
  @@map("evaluation_scores")
}

model CardUser {
  id         String   @id @default(cuid())
  assignedAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  cardId String
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([userId, cardId])
  @@map("card_users")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  type      String   @default("standard") // "standard" | "review_submission"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  cardId   String
  card     Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)

  // For attachment comments
  attachmentId String?
  attachment   Attachment? @relation(fields: [attachmentId], references: [id])

  @@index([cardId])
  @@map("comments")
}

model Attachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String // MIME type
  size      Int // bytes
  createdAt DateTime @default(now())

  // Relations
  cardId     String
  card       Card      @relation(fields: [cardId], references: [id], onDelete: Cascade)
  uploaderId String?
  uploader   User?     @relation(fields: [uploaderId], references: [id], onDelete: SetNull)
  comments   Comment[]

  @@index([cardId])
  @@index([uploaderId])
  @@map("attachments")
}

model Checklist {
  id        String   @id @default(cuid())
  name      String
  type      String // "todo", "feedback"
  position  Int
  createdAt DateTime @default(now())

  // Relations
  cardId String
  card   Card            @relation(fields: [cardId], references: [id], onDelete: Cascade)
  items  ChecklistItem[]

  @@index([cardId])
  @@map("checklists")
}

model ChecklistItem {
  id         String   @id @default(cuid())
  content    String
  isComplete Boolean  @default(false)
  position   Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  checklistId String
  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([checklistId])
  @@map("checklist_items")
}

model Activity {
  id        String   @id @default(cuid())
  action    String // "created", "moved", "updated", etc.
  entity    String // "card", "list", "board"
  entityId  String
  data      Json // Additional context
  createdAt DateTime @default(now())

  // Relations
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([entityId])
  @@map("activities")
}

// Weekly progress snapshot for burn-up charts
model WeeklyProgress {
  id               String   @id @default(cuid())
  weekStartDate    DateTime // Monday of the week
  totalStoryPoints Int // Total SP in the project
  completedPoints  Int // SP completed (tasks in Done list)
  tasksCompleted   Int // Number of tasks completed
  tasksTotal       Int // Total number of tasks
  createdAt        DateTime @default(now())

  // Relations
  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([boardId, weekStartDate])
  @@index([boardId])
  @@map("weekly_progress")
}

// Timeline blocks (phases)
model TimelineBlock {
  id        String   @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  position  Int // Sequence number (e.g., "Production 3")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boardId     String
  board       Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  blockTypeId String
  blockType   BlockType @relation(fields: [blockTypeId], references: [id])

  // Link to Planning view list for sync
  listId String? @unique
  list   List?   @relation(fields: [listId], references: [id])

  @@index([boardId])
  @@map("timeline_blocks")
}

// User weekly availability per board (project)
model UserWeeklyAvailability {
  id         String   @id @default(cuid())
  dedication Int // 0, 25, 33, 50, 75, 100 (percentage)
  weekStart  DateTime // Monday of the week (always normalized to Monday)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId, weekStart]) // One entry per user per week per board
  @@index([boardId])
  @@index([userId])
  @@index([weekStart])
  @@map("user_weekly_availability")
}

// Timeline events (milestones, deadlines)
model TimelineEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime // Same as startDate for single-day events
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  boardId     String
  board       Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  eventTypeId String
  eventType   EventType @relation(fields: [eventTypeId], references: [id])

  @@index([boardId])
  @@map("timeline_events")
}

// Time tracking
model TimeLog {
  id         String    @id @default(cuid())
  startTime  DateTime
  endTime    DateTime? // null = still in progress
  durationMs Int? // Calculated when ended
  isManual   Boolean   @default(false) // Admin manual adjustment
  notes      String? // For manual adjustments

  cardId String
  card   Card   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  listId String // Which list it was in (for tracking review time etc.)
  list   List   @relation(fields: [listId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cardId])
  @@index([userId])
  @@index([listId])
  @@map("time_logs")
}

// ============== SPINE TRACKER ==============

model SpineTrackerData {
  id        String   @id @default(cuid())
  data      Json     @default("{}") // Full spine tracker state as JSON
  version   Int      @default(1) // Optimistic concurrency version
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boardId String @unique // One spine tracker per board
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@map("spine_tracker_data")
}

model UserSpineSettings {
  id              String   @id @default(cuid())
  finalAssetsPath String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_spine_settings")
}

model SpineSkeletonModule {
  id              String   @id @default(cuid())
  skeletonName    String   @unique
  group           String   @default("other")
  status          String   @default("planned")
  zOrder          Int      @default(100)
  description     String?
  placementParent String?
  placementBone   String?
  placementNotes  String?
  generalNotes    String?
  animations      Json     @default("[]")
  skins           Json     @default("[]")
  events          Json     @default("[]")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([skeletonName])
  @@map("spine_skeleton_modules")
}

// In-app notifications
model Notification {
  id        String   @id @default(cuid())
  type      String // "review_requested", "task_approved", "card_moved_to_done", etc.
  title     String
  message   String
  data      Json     @default("{}")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@map("notifications")
}
